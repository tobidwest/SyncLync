<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <title>SyncLync</title>
    <style type="text/css">
      body {
        margin: 0;
        padding: 0;
        background-color: #0d1b2a;
        font-family: Open Sans, sans-serif;
        color: #ffffff;
        text-align: center;
      }

      #login-container {
        margin: 20px auto 0 auto;
        padding: 40px;
        width: 400px;
        background-color: #2e3c47;
        border-radius: 15px;
        opacity: 0;
      }

      #logo {
        opacity: 0;
      }

      h1 {
        margin-bottom: 10px;
        font-size: 22px;
      }

      p {
        margin-bottom: 30px;
        font-size: 16px;
        color: #ccc;
      }

      .qr-box {
        width: 200px;
        height: 200px;
        margin: 0 auto;
        background-color: #ffffff;
        padding: 10px !important;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .footer {
        margin-top: 30px;
        font-size: 14px;
        color: #888888;
      }
    </style>
  </head>
  <body>
    <img
      src="rsc/logo.png"
      alt="SyncLync Logo"
      id="logo"
      style="width: auto; height: 30px; margin-bottom: 20px; padding-top: 120px"
    />
    <div id="login-container">
      <h1>Link your account</h1>
      <p>Scan this QR code with your phone to continue.</p>
      <div id="qr-box" class="qr-box">
        <!-- QR code will be rendered here by JavaScript -->
      </div>
      <div class="footer">&copy; 2025 TU Berlin</div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
      var deviceCode = null;

      function startDeviceAuth() {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/device/start", true);
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4 && xhr.status === 200) {
            var data = JSON.parse(xhr.responseText);
            deviceCode = data.device_code;
            new QRCode(document.getElementById("qr-box"), {
              text: data.verification_uri,
              width: 200,
              height: 200,
              colorDark: "#000000",
              colorLight: "#ffffff",
            });
            // Show device code in console for debugging
            console.log("Device code:", data.verification_uri);

            // Make sure the generated QR code fills the box
            var qrImg = document.querySelector("#qr-box img");
            if (qrImg) {
              qrImg.style.width = "100%";
              qrImg.style.height = "100%";
              qrImg.style.display = "block";
            }

            // Show login container and logo
            document.getElementById("logo").style.opacity = "1";
            document.getElementById("login-container").style.opacity = "1";

            pollForAuth();
          }
        };
        xhr.send();
      }

      function pollForAuth() {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/device/poll", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              // Authenticated!
              window.location.href = "/tv/app.html";
            } else if (xhr.status === 202) {
              // Authorization pending, poll again after delay
              setTimeout(pollForAuth, 2000);
            } else {
              // Error (expired, invalid, etc)
              document.getElementById("login-container").innerHTML =
                "<h1>Link failed</h1><p>Code expired or invalid. Please reload.</p>";
            }
          }
        };
        try {
          xhr.send(JSON.stringify({ device_code: deviceCode }));
        } catch (e) {
          setTimeout(pollForAuth, 2000);
        }
      }

      function checkLoginStatus() {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", "/api/collections", true);
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              window.location.href = "app.html";
            } else if (xhr.status === 401) {
              console.log(
                "The 401 erorr you see in the console is intended. You are not logged in, starting device auth..."
              );
              startDeviceAuth();
            }
          }
        };
        xhr.send();
      }

      checkLoginStatus();

      // Button navigation
      document.addEventListener("keydown", function (event) {
        if (event.keyCode === 403 || event.key === "r") {
          window.location.href = "index.html";
        }
      });
    </script>
  </body>
</html>
